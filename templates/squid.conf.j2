{{ ansible_managed | comment }}

http_port {{ squid_port }}

cache_effective_user {{ squid_user }}
cache_effective_group {{ squid_group }}

{% for network in squid_networks %}
acl {{ network.name }} {{ network.type }} {{ network.range }} {{ network.comment | default(None) | comment or omit }}
{% endfor %}

{% if squid_append_domain is defined %}
append_domain {{ squid_append_domain }}
{% endif %}

acl SSL_ports port 443
{% if squid_safe_ports is defined %}
{% for safe_port in squid_safe_ports %}
acl Safe_ports port {{ safe_port }}
{% endfor %}
{% endif %}
acl CONNECT method CONNECT

http_access deny !Safe_ports

# Deny CONNECT to other than secure SSL ports
http_access deny CONNECT !SSL_ports

http_access allow localhost
http_access deny

#http_access deny to_localhost

http_access allow localnet
http_access allow localhost

http_access deny all

# Uncomment and adjust the following to add a disk cache directory.
cache_dir {{ squid_cache_dir }}

coredump_dir /var/spool/squid

refresh_pattern ^ftp:		1440	20%	10080
refresh_pattern ^gopher:	1440	0%	1440
refresh_pattern -i (/cgi-bin/|\?) 0	0%	0
refresh_pattern .		0	20%	4320

{% if squid_cache_replacement_policy is defined %}
cache_replacement_policy {{ squid_cache_replacement_policy }}
{% endif %}

{% if squid_maximum_object_size_mb is defined %}
maximum_object_size {{ squid_maximum_object_size_mb }} MB
{% endif %}

{% if squid_acls is defined %}
{% for acl in squid_acls %}
acl {{ acl.name }} {{ acl.classifier }} {{ acl.value }}
{% endfor %}
{% endif %}

{% if squid_cache_rules is defined %}
{% for rule in squid_cache_rules %}
cache {{ rule.decision }} {{ rule.acl }}
{% endfor %}
{% endif %}
